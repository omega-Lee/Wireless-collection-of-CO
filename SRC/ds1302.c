#include"ds1302.h"

//---DS1302дͶȡʱĵַ---//
//---ʱ λдλ;-------//
uchar code READ_RTC_ADDR[7] = {0x81, 0x83, 0x85, 0x87, 0x89, 0x8b, 0x8d}; 
uchar code WRITE_RTC_ADDR[7] = {0x80, 0x82, 0x84, 0x86, 0x88, 0x8a, 0x8c};
//                д
// 801 0 00000 0811 0 00000 1
// 821 0 00001 0, 831 0 00001 1
// 841 0 00010 0, 841 0 00010 1,
// 861 0 00011 0, 861 0 00011 1,
// 881 0 00100 0, 881 0 00100 1,
// 8a1 0 00101 0, 8a1 0 00101 1,
// 8c1 0 00110 0, 8c1 0 00110 1,

//---DS1302ʱӳʼ2020/5/2/5/3:54/00---//
//---洢˳ʱ,洢ʽBCD---//
uchar TIME[7] = {0, 0x57, 0x4, 0x02, 0x05, 0x05, 0x20};

//0000 0000=
//0000 0000=
//0001 0010=
//0000 0111=
//0000 0101=
//0001 0110=


/*******************************************************************************
*            : Ds1302Write
* 		   : DS1302ַ+ݣ
*              : addr,dat
*              : 
*******************************************************************************/

void Ds1302Write(uchar addr, uchar dat)
{
	uchar n;
	RST = 0;
	_nop_();//ʱһ 1us

	SCLK = 0;//ȽSCLKõ͵ƽ
	_nop_();
	RST = 1; //ȻRST(CE)øߵƽ
	_nop_();
	
	//ʼͰλַ
	for (n=0; n<8; n++)
	{
		DSIO = addr & 0x01;//ݴӵλʼ ֻһλ
		addr >>= 1;//ַһλ ȥλ
		SCLK = 1;//ʱDS1302ȡ
		_nop_();
		SCLK = 0;//ʱ Ϊһεַ׼
		_nop_();
	}
	for (n=0; n<8; n++)
	{
		DSIO = dat & 0x01;//ݴӵλʼ ֻһλ
		dat >>= 1;//һλ ȥλ
		SCLK = 1;//ʱDS1302ȡ
		_nop_();
		SCLK = 0;//ʱݷio Ϊһεַ׼
		_nop_();	
	}	
	
	RST = 0;//ݽ
	_nop_();
}

/*******************************************************************************
*            : Ds1302Read
* 		   	 : ȡһַ
*              : addr
*              : dat
*******************************************************************************/

uchar Ds1302Read(uchar addr)
{
	uchar n,dat,dat1;
	RST = 0;
	_nop_();

	SCLK = 0;//ȽSCLKõ͵ƽ
	_nop_();
	RST = 1;//ȻRST(CE)øߵƽ
	_nop_();

	for(n=0; n<8; n++)//ʼͰλַ
	{
		DSIO = addr & 0x01;//ݴӵλʼ
		addr >>= 1;
		SCLK = 1;//ʱDS1302ȡ
		_nop_();
		SCLK = 0;//DS1302½ʱ
		_nop_();
	}
	_nop_();
	for(n=0; n<8; n++)//ȡ8λ
	{
		dat1 = DSIO;//λʼ
		dat = (dat>>1) | (dat1<<7);//ÿֻȡdat1һλ
		SCLK = 1;
		_nop_();
		SCLK = 0;//DS1302½ʱ
		_nop_();
	}

	RST = 0;
	_nop_();	//ΪDS1302λȶʱ,ġ
	SCLK = 1;
	_nop_();
	DSIO = 0;
	_nop_();
	DSIO = 1;
	_nop_();
	return dat;	
}

/*******************************************************************************
*            : Ds1302Init
* 		   : ʼDS1302.
*              : 
*              : 
*******************************************************************************/

void Ds1302Init()
{
	uchar n;
	uchar flag;
	flag=Ds1302Read(0xc0);
	if(flag=0)
	{
		Ds1302Write(0xc0, 1);
		Ds1302Write(0x8E,0X00);		 //ֹдǹرд 8e=1 0 00111 0 wpдλ 0->δд
		for (n=0; n<7; n++)//д7ֽڵʱźţʱ
		{
		Ds1302Write(WRITE_RTC_ADDR[n],TIME[n]);	
		}
		Ds1302Write(0x8E,0x80);		 //д
	}

	
}

/*******************************************************************************
*            : Ds1302ReadTime
* 		     : ȡʱϢ
*              : 
*              : 
*******************************************************************************/

void Ds1302ReadTime()
{
	uchar n;
	for (n=0; n<7; n++)//ȡ7ֽڵʱźţʱ
	{
		TIME[n] = Ds1302Read(READ_RTC_ADDR[n]);
	}
		
} 


